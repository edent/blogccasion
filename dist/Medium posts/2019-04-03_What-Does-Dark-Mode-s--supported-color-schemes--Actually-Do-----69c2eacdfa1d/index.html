<p>The <a href="https://webkit.org/blog/8517/release-notes-for-safari-technology-preview-71/">Release Notes of Safari Technology Preview 71</a> mentioned two new dark mode features:</p>
<blockquote>
<p>‚Ä¢ Added experimental support for a <code>supported-color-schemes</code> CSS property (<a href="https://trac.webkit.org/changeset/238001/webkit/">r238001</a>).<br>
‚Ä¢ Changed the default document background and text colors in dark mode and when <code>dark</code> is listed as a <code>supported-color-schemes</code> on the document or body element (<a href="https://trac.webkit.org/changeset/238212/webkit/">r238212</a>).</p>
</blockquote>
<p>These were renamed to just <code>color-scheme</code> in <a href="https://webkit.org/blog/8834/release-notes-for-safari-technology-preview-81/">Technology Preview 81</a>:</p>
<blockquote>
<p>‚Ä¢ Renamed <code>supported-color-schemes</code> to <code>color-scheme</code> (<a href="https://trac.webkit.org/changeset/244408/webkit/">r244408</a>)<br>
‚Ä¢ Standardized the <code>&lt;meta name=&quot;color-scheme&quot;&gt;</code> separator (<a href="https://trac.webkit.org/changeset/244413/webkit/">r244413</a>)</p>
</blockquote>
<p>This is actually talking about a new <strong>meta tag</strong> <code>&lt;meta name=&quot;color-scheme&quot;&gt;</code> and a <strong>CSS property</strong> <code>color-scheme</code> that were both proposed in <a href="https://github.com/w3c/csswg-drafts/issues/3299">a CSS WG GitHub issue</a> (under the old name <code>supported-color-schemes</code>), but the meta tag is now being standardized in the <a href="https://github.com/whatwg/html/issues/4504">WHATWG</a>.</p>
<h4>User-Agent stylesheets</h4>
<p>üí° Before I continue, let me briefly describe what a <strong>user-agent stylesheet</strong> is: a user-agent (UA for short) stylesheet determines the default look and feel of a page. As the name suggests, a UA stylesheet is something that is dependent on the UA in question. You can have a look at <a href="https://chromium.googlesource.com/chromium/blink/+/master/Source/core/css/html.css">Chrome‚Äôs (and Chromium‚Äôs) UA stylesheet</a> and compare it to <a href="https://dxr.mozilla.org/mozilla-central/source/layout/style/res/html.css">Firefox‚Äôs</a> or <a href="https://trac.webkit.org/browser/trunk/Source/WebCore/css/html.css">Safari‚Äôs (and WebKit‚Äôs)</a>. Typically, all UA stylesheets agree and make texts black and background colors white, but there are also differences, for example, how to display form controls. Side remark: To overcome these differences, CSS normalizers and CSS resets have become a thing (read this <a href="http://nicolasgallagher.com/about-normalize-css/">article</a> about the difference).</p>
<p>So let‚Äôs have a closer look at <a href="https://trac.webkit.org/browser/trunk/Source/WebCore/css/html.css">WebKit‚Äôs user-agent stylesheet</a> and what it does regarding dark mode (do a full text search for ‚Äúdark‚Äù in the code). It changes the UA stylesheet‚Äôs default values based on whether dark mode is on or off. To illustrate this, here‚Äôs one such CSS rule (using the¬†<code>[:matches](https://css-tricks.com/almanac/selectors/m/matches/)</code> pseudo class and WebKit-internal variables like <code>-apple-system-control-background,</code> as well as the WebKit-internal preprocessor directive <code>#if defined</code>):</p>
<p>input,<br>
input:matches([type=&quot;password&quot;], [type=&quot;search&quot;]) {<br>
-webkit-appearance: textfield;<br>
#if defined(HAVE_OS_DARK_MODE_SUPPORT) &amp;&amp;<br>
HAVE_OS_DARK_MODE_SUPPORT<br>
color: text;<br>
background-color: -apple-system-control-background;<br>
#else<br>
background-color: white;<br>
#endif<br>
[‚Ä¶]<br>
}</p>
<p>So looking at a concrete example, it changes this light mode experience‚Ä¶</p>
<p><img src="img/1__3qyY34yqYyctFJ5eEgeoIQ.png" alt="Default rendering in light¬†mode">
Default rendering in light¬†mode</p>
<p>‚Ä¶to this dark mode experience‚Ä¶</p>
<p><img src="img/1__4T__hSjFgl__BeAjwUTi5uog.png" alt="Default rendering in dark¬†mode">
Default rendering in dark¬†mode</p>
<p>Note that there is <em>no</em> custom CSS at all included, let alone the <code>@media (prefers-color-scheme)</code> media query. The above is purely based on the UA stylesheet.</p>
<h4>The meta tag <code>&lt;meta name=&quot;color-scheme&quot;&gt; and the CSS property &quot;color-scheme&quot;</code></h4>
<p>Now back to the meta tag and the CSS property (that has the same behavior as the meta tag, but optionally limited to just subsections of a page). They both mean that UAs know early in parsing which color scheme is to be used, since this may impact the default appearance, for example, when rendering the default page background, form controls, the default selection color, but also other UA-controlled UI like misspelling underlines. In consequence, this avoids flashes caused by delayed switches between color schemes.</p>
<p>Here are some of the values the meta tag and the CSS property can take (quoted from <a href="https://github.com/smfr">Simon Fraser</a>‚Äôs <a href="https://github.com/w3c/csswg-drafts/issues/3299#issue-378507535">GitHub Issue text</a>, <em>italic</em> emphasis mine):</p>
<ul>
<li><code>light dark</code>‚ÄîThe UA will choose the light or dark theme to match the user‚Äôs preference. <em>If the user‚Äôs preference does not match something in the list, the UA is allowed to apply transformations to the content</em>.</li>
<li><code>only</code> (synonym for <code>light only</code>‚ÄîThe UA will only ever render the content in the light color scheme, <em>and never apply transformations</em>.</li>
<li><code>light dark only</code>‚ÄîThe UA will choose the first of the listed schemes that it supports taking user preference into account, <em>and never apply transformations</em>.</li>
</ul>
<p>So iff (if, and only if) you know what you‚Äôre doing, in combination with <code>only</code>, you can then design things like your form controls to have no such transformations. In most cases, leaving it to the UA might be the better choice, as you can see in the example below, where, while in dark mode, I force my form controls to look like <code>light only</code>.</p>
<p><img src="img/1__0LutJrvpDsXEJDfINY2D0w.png" alt="">
<img src="img/1__rM0uu9Zk415yXfGtvlVjQg.png" alt="Left: glaring and without transformations. Right: the easier-on-the-eyes UA¬†default.">
Left: glaring and without transformations. Right: the easier-on-the-eyes UA¬†default.</p>
<p>This article was updated to reflect the name change from <code>supported-color-schemes</code> (plural) to <code>color-scheme</code> (singular).</p>
