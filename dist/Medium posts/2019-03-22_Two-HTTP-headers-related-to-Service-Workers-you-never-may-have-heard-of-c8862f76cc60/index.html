<p>The other day, one of my former Google Mobile Solutions Consultant colleagues sent an email to an internal mailing list that (paraphrased) went like this:</p>
<blockquote>
<p>“I was shocked that during now more than two years of supporting Service Worker implementations, I only found out about the <code>service-worker-allowed</code> header today.” 😳</p>
</blockquote>
<p>I suspect at least some of you are the same, so let me explain not just this, but also a second interesting HTTP header related to Service Workers that are both probably <em>not</em> the ones you read about when you follow any of the many Service Worker tutorials out there.</p>
<h4><strong>Header</strong> № 1: `<strong>service-worker-allowed`</strong></h4>
<p>This is one of the a little more obscure Service Worker features, but it’s very useful. You can see it in action on Google Docs, where the URL you’re on with <a href="https://support.google.com/accounts/answer/1721977?co=GENIE.Platform%3DDesktop&amp;hl=en">multi-account login</a> is something like <code>https://docs.google.com/document/u/0/</code> (the final number determines the active account), but where the actual Service Worker JavaScript file comes from <code>https://docs.google.com/document/offline/serviceworker.js?ouid=ude32cf1e51077bff&amp;zx=hyah3kexco7d</code> (your query parameters may differ).</p>
<p>Now why does this matter? Let’s briefly recall the <a href="https://developers.google.com/web/ilt/pwa/introduction-to-service-worker#registration_and_scope">concept of a Service Worker’s</a> <code>[scope](https://developers.google.com/web/ilt/pwa/introduction-to-service-worker#registration_and_scope)</code>: The <code>scope</code> of the Service Worker determines which files the Service Worker controls, in other words, from which path the Service Worker will intercept requests. The default <code>scope</code> is the location of the Service Worker file, and extends to all directories below. So if <code>serviceworker.js</code> is located in the root directory, the Service Worker will control requests from all files at this domain.</p>
<p>Now you may notice that in the case of Google Docs, the default <code>scope</code> would be <code>https://docs.google.com/document/offline/</code>, which is not enough, as the user is working in <code>https://docs.google.com/document/u/0/</code>. This is where finally the <code>service-worker-allowed</code> header comes in. It allows Google Docs to ask for a wider <code>scope</code> of <code>https://docs.google.com/document/</code> instead 🎉. This header is <a href="https://wpt.fyi/results/service-workers/service-worker/Service-Worker-Allowed-header.https.html?label=master&amp;product=chrome%5Bexperimental%5D&amp;product=edge&amp;product=firefox%5Bexperimental%5D&amp;product=safari%5Bexperimental%5D&amp;aligned&amp;q=service-worker-allowed">supported by all browsers</a> and if you’re interested in all the details, this is the <a href="https://w3c.github.io/ServiceWorker/#service-worker-allowed">deep link to the header’s section in the spec</a>. You can see it in action in the screenshot below.</p>
<p><img src="img/1__DWL0rYFHSUOcbOKP0L9jJQ.png" alt="HTTP header `service-worker-allowed` in action on Google Docs">
HTTP header `service-worker-allowed` in action on Google Docs</p>
<h4>Header № 2: `<strong>service-worker`</strong></h4>
<p>As we’re at it, another header you might not have heard of is <code>service-worker</code>. It indicates when a request is for a Service Worker’s script resource and helps administrators and webmasters log such requests and detect threats (so talk to them, they’ll probably appreciate it; <a href="https://twitter.com/jaffathecake">Jake Archibald</a>’s <a href="https://jakearchibald.com/2014/launching-sw-without-breaking-the-web/#pros">article</a> has all the details). This header as well is <a href="https://wpt.fyi/results/service-workers/service-worker/service-worker-header.https.html?label=master&amp;product=chrome%5Bexperimental%5D&amp;product=edge&amp;product=firefox%5Bexperimental%5D&amp;product=safari%5Bexperimental%5D&amp;aligned&amp;q=service-worker">supported by all browsers</a>, and here is the <a href="https://w3c.github.io/ServiceWorker/#service-worker-script-request">deep link to its section in the spec</a>. You can see it in action when you go to Facebook. Facebook’s Service Worker comes from <code>[https://www.facebook.com/sw?s=push](https://www.facebook.com/sw?s=push)</code>, but if you try to open this URL, you’ll not see the JavaScript code, but a Facebook error page. You actually <em>need</em> to send the header in order for Facebook to return the code.</p>
<p><img src="img/1__yv__O2J0JvC__HHcnS5Q1MTg.png" alt="HTTP header `service-worker` in action on Facebook">
HTTP header `service-worker` in action on Facebook</p>
<p>This initially caught me when I developed the <a href="https://github.com/google/service-worker-detector#--installation">👷‍♀️ 👷 Service Worker Detector browser extension</a>, but after reading the spec, I was then <a href="https://github.com/google/service-worker-detector/blob/f257aa9a77951f8ec972bf271093c75e86f73e55/contentscript.js#L71-L75">sending the correct header</a> in the extension’s content script, so that it now works as expected.</p>
<p><img src="img/1__iGs__TUJQylaz__WUJv1CfCg.png" alt="👷‍♀️ 👷 Service Worker Detector browser extension running on Facebook">
<a href="https://github.com/google/service-worker-detector#--installation">👷‍♀️ 👷 Service Worker Detector browser extension</a> running on Facebook</p>
<p>If you encounter this header being required by the server, for quick debugging sessions in the browser or from the terminal, a cool Chrome DevTools tip is to right-click the Service Worker request and then “Copy as cURL” or “Copy as fetch”. 👌</p>
<p><img src="img/1__lV7wiTSY7NnoOTFve7rCIA.png" alt="Fetch a resource exactly as the browser did with “Copy as cURL” or “Copy as fetch”">
Fetch a resource exactly as the browser did with “Copy as cURL” or “Copy as fetch”</p>
<p>Did <em>you</em> know about these headers? Let me know in the comments or ping me, <a href="https://twitter.com/tomayac">@tomayac</a>, on Twitter. Oh, by the way, while I still have your attention, the Mobile Solutions Consultant team (my former team) are <a href="https://careers.google.com/jobs/results/?company=Google&amp;company=YouTube&amp;employment_type=FULL_TIME&amp;hl=en_US&amp;jlo=en_US&amp;q=%22Mobile%20Solutions%20Consultant%22&amp;sort_by=relevance">hiring</a>, and so is my current team, the Chrome Developer Relations team, where we’re looking for <a href="https://careers.google.com/jobs/results/?company=Google&amp;company=YouTube&amp;employment_type=FULL_TIME&amp;hl=en_US&amp;jlo=en_US&amp;q=%22developer%20advocate,%20web%22&amp;sort_by=relevance">Developer Advocates</a> and <a href="https://careers.google.com/jobs/results/?company=Google&amp;company=YouTube&amp;employment_type=FULL_TIME&amp;hl=en_US&amp;jlo=en_US&amp;q=%22Developer%20Programs%20Engineer,%20Web%22&amp;sort_by=relevance">Developer Programs Engineers</a>…</p>
