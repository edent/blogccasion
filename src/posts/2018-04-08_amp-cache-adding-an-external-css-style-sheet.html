---
layout: layouts/post.njk
title: "AMP cache adding an external css style sheet?"
author: "Thomas Steiner"
date: "2018-04-08T13:04:37"
permalink: 2018/04/08/amp-cache-adding-an-external-css-style-sheet-130437/index.html
tags:
  - Technical
---
<p class="c16"><span class="c6">I dug into the </span><span class="c12"><a class="c20" href="https://github.com/ampproject/amp-toolbox/tree/master/optimizer">AMP Toolbox Optimizer</a></span><span class="c6">&nbsp;a bit and realized it replaces the boilerplate CSS with an externally referenced file called </span><span class="c12"><a class="c20" href="https://cdn.ampproject.org/v0.css">v0.css</a></span><span class="c6">&nbsp;and was like &#x1f914; hmmm, why is that? Here&rsquo;s a </span><span class="c12"><a class="c20" href="https://www.webpagetest.org/result/180213_DB_2b7be8aae838d5bfc67813ec8f58e208/1/details/#waterfall_view_step1">real world example</a></span><span class="c6">, check for the 2nd request </span><span class="c18 c6">v0.css</span><span class="c4">. So I tried to understand what was going on, if you care, read on.</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c13 c17 c11"><strong>Introduction</strong></span></p><p class="c0"><span class="c13 c17 c11"></span></p><p class="c16"><span class="c6">Initially, the browser doesn&rsquo;t know what AMP components like </span><span class="c6 c19">&lt;amp-something&gt;</span><span class="c4">&nbsp;are. It only knows after the AMP runtime (and each components&rsquo; libraries) is loaded. The problem is, browsers are forgiving, so they just assume unknown tags are there on error, and ignore them:</span></p><p class="c0"><span class="c4"></span></p><p class="c5"><span class="c13 c18 c6">&lt;dif&gt;</span></p><p class="c5"><span class="c13 c18 c6">&nbsp; &lt;strong&gt;Yeah!&lt;/strong&gt;</span></p><p class="c5"><span class="c13 c18 c6">&lt;/dif&gt;</span></p><p class="c0"><span class="c7 c6"></span></p><p class="c16"><span class="c6">Note the error? I wrote </span><span class="c18 c6">&lt;dif&gt;</span><span class="c6">, and by that created an unknown tag. The browser will still display my </span><span class="c6 c22">Yeah!</span><span class="c4">, and ignore everything else.</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c6">It gets worse when you add AMP, as some AMP components alter the box model of things. You can see the effect in </span><span class="c15"><a class="c20" href="https://blog.tomayac.com/images/test.html">this example</a></span><span class="c4">&nbsp;file (view source):</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 224.00px; height: 326.00px;"><img alt="" src="images/image2.png" style="width: 224.00px; height: 326.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c6">&#8203;The fake </span><span class="c18 c6">&lt;amp-karussell&gt;</span><span class="c4">&nbsp;I have created simulates this issue. You can&rsquo;t visually differentiate the two side by side AMP images from my fake carousel. </span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c13 c11 c17"><strong>Adding AMP</strong></span></p><p class="c0"><span class="c13 c17 c11"></span></p><p class="c16"><span class="c6">The AMP boilerplate essentially makes sure that for a grace period nothing is shown (white screen). You can simulate this by </span><span class="c12"><a class="c20" href="https://developers.google.com/web/updates/2017/04/devtools-release-notes#block-requests">request-blocking</a></span><span class="c6">&nbsp;the AMP runtime on a </span><span class="c12"><a class="c20" href="https://ampbyexample.com/components/amp-carousel/">real AMP</a></span><span class="c6">&nbsp;page and you will notice that after the </span><span class="c12"><a class="c20" href="https://github.com/ampproject/amphtml/blob/9b101fa000b7dc911073cacdf3ccafb187c2012d/build-system/tasks/extension-generator/index.js#L258">grace period of 8 seconds</a></span><span class="c6">&nbsp;is over, the layout is messed up, the </span><span class="c18 c6">&lt;div&gt;</span><span class="c4">s form the last example show up as block element, as HTML&rsquo;s creators wanted them to appear:</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 261.21px; height: 530.50px;"><img alt="" src="images/image3.png" style="width: 261.21px; height: 530.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c16"><span class="c4">&#8203;</span></p><p class="c16"><span class="c13 c17 c11"><strong>Toolbox Optimizations</strong></span></p><p class="c0"><span class="c13 c17 c11"></span></p><p class="c16"><span class="c6">Now to the actual question, why the </span><span class="c12"><a class="c20" href="https://cdn.ampproject.org/v0.css">CSS file</a></span><span class="c6">? It&rsquo;s </span><span class="c6 c8">not</span><span class="c6">&nbsp;the boilerplate, but sort of an </span><span class="c6 c8">AMP CSS Normalizer</span><span class="c6">&nbsp;(more to that in the next section). With the </span><span class="c12"><a class="c20" href="https://github.com/ampproject/amp-toolbox/">AMP Toolbox</a></span><span class="c6">, you can simply on your own site already apply the optimizations that the cache would apply on the CDN. I&rsquo;m quoting directly from the </span><span class="c12"><a class="c20" href="https://github.com/ampproject/amp-toolbox/tree/master/optimizer#why-is-it-faster">documentation</a></span><span class="c4">:</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c9 c6 c8">&ldquo;In order to avoid Flash of Unstyled Content (FOUC) and reflows resulting from to the usage of web-components, AMP requires websites to add the amp-boilerplate in the header.</span></p><p class="c0"><span class="c9 c6 c8"></span></p><p class="c16"><span class="c9 c6 c8">The amp-boilerplate renders the page invisible by changing it&rsquo;s opacity, while the fonts and the AMP Runtime load. Once the AMP runtime is loaded, it is able to correctly set the sizes of the custom elements and once that happens, the runtimes makes the page visible again.</span></p><p class="c0"><span class="c9 c6 c8"></span></p><p class="c16"><span class="c9 c6 c8">As a consequence, the first render of the page doesn&rsquo;t happen until the AMP Runtime is loaded.</span></p><p class="c0"><span class="c9 c6 c8"></span></p><p class="c16"><span class="c9 c6 c8">To improve this, AMP server-side rendering applies the same rules as the AMP Runtime on the server. This ensures that the reflow will not happen and the AMP boilerplate is no longer needed. The first render no longer depends on the AMP Runtime being loaded, which improves load times.</span></p><p class="c0"><span class="c6 c8 c9"></span></p><p class="c16"><span class="c6 c22 c8 c27">Caveats: it&rsquo;s important to note that, even though the text content and layout will show faster, content that depends on the custom AMP elements (eg: any element in the page that starts with &rsquo;amp-&rsquo;) will only be visible after the AMP Runtime is loaded.&rdquo;</span></p><p class="c0"><span class="c27 c6 c22 c8"></span></p><p class="c16"><span class="c13 c17 c11"><strong>Looking into the CSS File</strong></span></p><p class="c0"><span class="c13 c17 c11"></span></p><p class="c16"><span class="c6">So now what does the</span><span class="c11">&nbsp;</span><span class="c24"><a class="c20" href="https://cdn.ampproject.org/v0.css">CSS file</a></span><span class="c6">&nbsp;that I called </span><span class="c6 c8">AMP CSS Normalizer</span><span class="c6">&nbsp;do? If we look at the </span><span class="c15"><a class="c20" href="https://blog.tomayac.com/images/v0_beautified.css">beautified source code here</a></span><span class="c4">, we can see this beauty:</span></p><p class="c0"><span class="c4"></span></p><p class="c5"><span class="c18 c6">.i-amphtml-layout-container,.i-amphtml-layout-fixed-height,.</span><span class="c14 c6">i-amphtml-layout-responsive</span><span class="c13 c18 c6">,[layout=container],[layout=fixed-height][height],[layout=responsive][width][height]:not(.i-amphtml-layout-responsive),[width][height][sizes]:not(.i-amphtml-layout-responsive) {</span></p><p class="c5"><span class="c6 c18">&nbsp; </span><span class="c13 c14 c6">display: block;</span></p><p class="c5"><span class="c13 c18 c6">&nbsp; position: relative</span></p><p class="c5"><span class="c13 c18 c6">}</span></p><p class="c0"><span class="c6 c7"></span></p><p class="c16"><span class="c4">The toolbox optimizes&hellip;</span></p><p class="c0"><span class="c4"></span></p><p class="c28"><span class="c2">&lt;</span><span class="c1">amp-img</span><span class="c2">&nbsp;</span><span class="c3">width</span><span class="c2">=</span><span class="c10">360</span><span class="c2">&nbsp;</span><span class="c3">height</span><span class="c2">=</span><span class="c10">200</span><span class="c2">&nbsp;</span><span class="c3">layout</span><span class="c2">=</span><span class="c10">responsive</span><span class="c2">&nbsp;</span><span class="c3">src</span><span class="c2">=</span><span class="c10">image.png</span><span class="c2">&gt;&lt;/</span><span class="c1">amp-img</span><span class="c2 c13">&gt;</span></p><p class="c0"><span class="c2 c13"></span></p><p class="c16"><span class="c4">&hellip;to&hellip;</span></p><p class="c0"><span class="c4"></span></p><p class="c28"><span class="c2">&lt;</span><span class="c1">amp-img</span><span class="c2">&nbsp;</span><span class="c3">width</span><span class="c2">=</span><span class="c10">&quot;360&quot;</span><span class="c2">&nbsp;</span><span class="c3">height</span><span class="c2">=</span><span class="c10">&quot;200&quot;</span><span class="c2">&nbsp;</span><span class="c3">layout</span><span class="c2">=</span><span class="c10">&quot;responsive&quot;</span><span class="c2">&nbsp;</span><span class="c3">src</span><span class="c2">=</span><span class="c10">&quot;image.png&quot;</span><span class="c2">&nbsp;</span><span class="c3">class</span><span class="c2">=</span><span class="c10">&quot;</span><span class="c22 c23">i-amphtml-layout-responsive</span><span class="c10">&nbsp;i-amphtml-layout-size-defined&quot;</span><span class="c2">&nbsp;</span><span class="c3">i-amphtml-layout</span><span class="c2">=</span><span class="c10">&quot;responsive&quot;</span><span class="c2">&gt;&lt;/</span><span class="c1">amp-img</span><span class="c2 c13">&gt;</span></p><p class="c0"><span class="c2 c13"></span></p><p class="c16"><span class="c6">What this means is that when we have a </span><span class="c6 c22">responsive</span><span class="c6">&nbsp;</span><span class="c18 c6">&lt;amp-img&gt;</span><span class="c6">&nbsp;and even if the browser has no clue what an </span><span class="c6 c25">&lt;amp-img&gt;</span><span class="c4">&nbsp;is, it would still display it as a block element.</span></p><p class="c0"><span class="c4"></span></p><p class="c16"><span class="c4">Styling actually (and maybe surprisingly) still works, even if the browser apart from that ignores the unknown tag:</span></p><p class="c0"><span class="c4"></span></p><p class="c5"><span class="c13 c18 c6">&lt;style&gt;</span></p><p class="c5"><span class="c18 c6">&nbsp; </span><span class="c6 c14">beer</span><span class="c13 c18 c6">&nbsp;{</span></p><p class="c5"><span class="c13 c18 c6">&nbsp; &nbsp; display: block;</span></p><p class="c5"><span class="c13 c18 c6">&nbsp; &nbsp; border: solid red 1px;</span></p><p class="c5"><span class="c13 c18 c6">&nbsp; }</span></p><p class="c5"><span class="c13 c18 c6">&lt;/style&gt;</span></p><p class="c5"><span class="c18 c6">Wooohoo, </span><span class="c14 c6">&lt;beer&gt;</span><span class="c13 c18 c6">beer!&lt;/beer&gt; Cheers!</span></p><p class="c0"><span class="c7 c6"></span></p><p class="c16"><span class="c6">This makes sure that the </span><span class="c18 c6">&lt;beer&gt;</span><span class="c4">&nbsp;tag does what I told it to do:</span></p><p class="c16"><span class="c4">&nbsp;</span></p><p class="c16"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 393.00px; height: 70.00px;"><img alt="" src="images/image1.png" style="width: 393.00px; height: 70.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c16"><span class="c4">Hope this was helpful. </span></p><p class="c0"><span class="c9 c26"></span></p>